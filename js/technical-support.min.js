(function(a){a.fn.technicalSupportPlugin=function(j){var e={backgroundSelecor:"#container",timeDisapiarinLastWindow:3000};var c=false;var b=true;var f=null;var h=null;var i=true;var d=a.extend({},e,j);var g=this;initialize=function(){detectBrowser();initTruncateMethod();renderTSLink()};detectBrowser=function(){var l=navigator.appVersion.match(/MSIE (\d)\.0/);if(l){c=true;f=l[1]}var k=navigator.appVersion.match(/OS \d+_\d+/);if(k){b=false}};initTruncateMethod=function(){String.prototype.truncate=function(){var n="";var l=a(".modal_window > div").width();var k=Math.floor(35*l/600*(l*1.3/600));var m=k-2;if(this.length>k){n=this.replace(new RegExp("([a-zA-Zа-яА-ЯёЁ0-9\\s_\\-!]{1,"+m+"}).+"),"$1...")}else{n=this.slice(0)}return n}};renderTSLink=function(){g.append('<span class="ico_descus"></span>');g.addClass("main_TS_link").addClass("gradient_lime").addClass("border_radius");if(c&&f<9){g.css("top","38%")}else{var k=parseInt(g.width(),10)/2-18;g.css("marginTop","-"+k+"px")}linkHoverEvent();linkClickEvent()};linkHoverEvent=function(){g.hover(function(){a(this).stop(true,true).animate({left:"+=9px"},200)},function(){a(this).stop(true,true).animate({left:"-=9px"},200)})};linkClickEvent=function(){g.click(function(k){k.preventDefault();createModal("modal_TS")})};createModal=function(k){if(b){a(d.backgroundSelecor).addClass("bluring")}if(a("."+k).length>0){a(".modal_window").removeClass("makeInvisible")}else{if(k=="modal_TS"){renderModal("Технічна підтримка слухає","завершити чат",k);fillMainModal()}else{if(k=="modal_send"){renderModal("Чат завершено!","завершити вікно",k);fillSendModal()}}closeChat(k);dinamicHorizontalAlign(k);a(window).resize(function(){dinamicHorizontalAlign(k)});destroyModalEvent(k)}};chatInput=function(){a(".chat_input textarea").on("keypress",function(m){var k=a.trim(a(this).val());var l=k.length;if(m.keyCode==13){if(l>0||h){appendMessage()}}});a(".chat_file input[type=button]").on("click",function(){var k=a.trim(a(".chat_input textarea").val());var l=k.length;if(l>0||h){appendMessage()}})};appendMessage=function(r,n){var k="",p="";r=r||"Ви";var o=a(".chat_input textarea");n=n||a.trim(o.val());if(h){k='<a class="attached_file">'+h+"</a>"}if(r=="Підтримка"){p="support"}var l=new Date();var m=l.getMinutes()<10?"0"+l.getMinutes():l.getMinutes();var q=l.getDate()+"."+parseInt(l.getMonth()+1,10)+"."+l.getFullYear()+": "+l.getHours()+":"+m;a(".chat_main").append('<div class="one_message"><span class="'+p+'">'+r+" ("+q+"):</span><p>"+n+"</p>"+k+"</div>");o.val("");a(".chat_main").stop(true,true).animate({scrollTop:a(document).height()},600);h=null;a("#attached_file").empty().hide();if(n=="Перезапустив, допомогло, дякую."){imitateAnswer()}};imitateAnswer=function(){if(i){i=false;setTimeout(function(){h=null;appendMessage("Підтримка","Звертайтесь) Раді допомогти ;)")},3000)}};fileAttaching=function(){a("input[type=file]").change(function(){var k=a(this).val();var l=k.match(/\\*([a-zA-Zа-яА-ЯёЁ0-9\s_\-!]+\.\w{2,6})$/);if(l){a("#attached_file").html(l[1].truncate());a("#attached_file").css("display","block");h=l[1]}else{a(this).val("");h=null;a("#attached_file").trigger("click");alert("Некоректне ім'я файлу")}});a("#attached_file").click(function(k){k.preventDefault();a("#attached_file").empty().hide();a("input[type=file]").val("");h=null})};renderModal=function(l,k,m){a(".modal_window").remove();a("body").append('<div class="modal_window"><div class="'+m+'"><div class="quote"></div><div class="modal_header gradient_lime border_radius"><a class="close_window border_radius_3"><span class="ico_x2"></span>'+k+'</a><div><span class="ico_descus "></span> '+l+'</div></div><div class="modal_content gradient_lime_reverse border_radius"></div></div>')};fillMainModal=function(){a(".modal_content").html('<div class="chat_TS border_radius"><div class="chat_main"><div class="one_message"><span class="support">Підтримка (26.10.2012: 15:35):</span><p>Доброго дня, чим можу допомогти?</p></div><div class="one_message"><span>Ви (26.10.2012: 15:36):</span><p>У мене не працює праска. Чи зв\'язано це з тим, що на Марсі погана погода?</p><a class="attached_file">погода.doc</a></div><div class="one_message"><span class="support">Підтримка (26.10.2012: 15:39):</span><p>Перезапусть вашу праску...Повинно допомгти :)</p></div></div><div class="chat_input"><textarea rows="4">Перезапустив, допомогло, дякую.</textarea></div><div class="chat_file"><form method="post" action="" enctype="multipart/form-data"><input type="button" value="надіслати" class="go_button"><input type="file"><a href="#"><span>вкласти файл</span></a><a id="attached_file"></a></form></div></div>');fileAttaching();chatInput()};fillSendModal=function(){a(".modal_content").html('<div class="chat_TS border_radius">Надіслати копію чату на пошту<div class="enter_email"><input type="button" disabled="disabled" value="надіслати" class="go_button"><input type="email"  placeholder="Адреса електронної пошти"></div></div>');validateEmail()};dinamicHorizontalAlign=function(l){var k=parseInt(a("."+l).width(),10)/2;a("."+l).css("marginLeft","-"+k+"px");a("#attached_file").text(a("#attached_file").text().truncate())};destroyModalEvent=function(k){a(document).on("keyup",function(l){if(l.keyCode==27){if(k=="modal_TS"){manipulateWithModals(k)}else{destroyingModal(k)}}})};destroyingModal=function(l){var k=c?0:1000;a("."+l).addClass("goAnimationBack");setTimeout(function(){a("."+l).remove()},k-100);setTimeout(function(){a(".modal_window").addClass("makeInvisible");a(d.backgroundSelecor).removeClass("bluring")},k)};closeChat=function(k){a("."+k+" .close_window").on("click",function(l){l.preventDefault();manipulateWithModals(k)})};manipulateWithModals=function(l){destroyingModal(l);var k=c?0:1000;if(l=="modal_TS"){setTimeout(function(){createModal("modal_send")},k)}};validateEmail=function(){sendEmailClick();a("input[type=email]").on("keyup",function(l){var k=a(this).val();if(k.match(/^([a-zA-Z0-9]{1,20})([\._-]{1,1}[a-zA-Z0-9]{1,15})*@([a-z]+([\._-]{1,1}[a-z]{1,10})*\.{1,1}[a-z]{2,4})$/i)){a(".go_button").removeAttr("disabled");if(l.keyCode==13){a(".go_button").click()}}else{a(".go_button").attr("disabled","disabled")}})};sendEmailClick=function(){a(".go_button").on("click",function(){a(".chat_TS").html('<p class="thanx">Дякуємо за звернення до служби підтримки!</p>');setTimeout(function(){destroyingModal("modal_send")},d.timeDisapiarinLastWindow)})};initialize()}})(jQuery);